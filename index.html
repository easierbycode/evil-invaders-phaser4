<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Evil Invaders Phaser4</title>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <!-- Include Bootstrap CSS for styling UI elements -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .alert {
            background-color: #fafcfe06;
            border: none;
            color: #fafcfe77;
            padding: 5px;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: #000000;
            cursor: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100dvh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #baseUrl {
            display: none;
        }

        #game {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="assets/TweenMax.min.js"></script>
    <script src="assets/phaser.min.js"></script>
</head>

<body>
    <div id="game"></div>

    <!-- baseUrl for assets, uncomment and set if needed
    <span id="baseUrl">https://cmg.files.show/</span> -->
    <span id="baseUrl"></span>

    <!-- gamepad not connected alert (automatically hidden) -->
    <div id="gamepadAlert" class="alert alert-info text-center" style="position:absolute; top:0; width:100%;">
        ðŸŽ® PLEASE <strong>CONNECT GAMEPAD</strong> ðŸŽ®
    </div>
    <script>
        // Hide the gamepad alert when running inside Cordova. We listen for deviceready
        // because Cordova may not be injected at the time this script runs.
        function hideGamepadAlert() {
            const ga = document.getElementById('gamepadAlert');
            if (ga) ga.style.display = 'none';
        }

        if (window.cordova) {
            // Cordova object exists now â€” hide immediately
            hideGamepadAlert();
        }

        // Also hide when deviceready fires (covers the normal Cordova lifecycle)
        document.addEventListener('deviceready', () => {
            hideGamepadAlert();
        }, false);
    </script>
    <script type="module" src="/src/main.ts"></script>
    <script>
        let prevButtonStates = [];
        let fullscreenToggled = false; // Flag to ensure fullscreen is toggled only once

        window.addEventListener("gamepadconnected", (e) => {
            prevButtonStates[e.gamepad.index] = [];
            requestAnimationFrame(pollGamepads);
        });

        function pollGamepads() {
            function safeRequestFullscreen(target) {
                const request =
                    target.requestFullscreen ||
                    target.webkitRequestFullscreen ||
                    target.webkitRequestFullScreen ||
                    target.mozRequestFullScreen ||
                    target.msRequestFullscreen;
                if (!request) return;
                const result = request.call(target);
                if (result && typeof result.catch === "function") {
                    result.catch(() => { });
                }
            }

            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                const gp = gamepads[i];
                if (!gp) continue;
                if (!prevButtonStates[gp.index]) prevButtonStates[gp.index] = [];
                gp.buttons.forEach((btn, idx) => {
                    const prev = prevButtonStates[gp.index][idx] || false;
                    if (btn.pressed && !prev) {
                        // Restart - Select button (typically index 8)
                        if (idx === 8) {
                            if (gp.buttons[12] && gp.buttons[12].pressed) {
                                globalThis.__PHASER_GAME__.scene.scenes.forEach(s => {
                                    globalThis.__PHASER_GAME__.scene.stop(s.scene.key);
                                });
                                globalThis.__PHASER_GAME__.scene.start('HighScoreScene');
                            } else if (window.gameScene && window.gameScene.scene) {
                                window.gameScene.scene.restart();
                            }
                        }

                        // Pause - Start button (typically index 9)
                        if (idx === 9) {
                            if (window.gameScene.scene.isPaused()) {
                                window.gameScene.scene.resume();
                            } else {
                                window.gameScene.scene.pause();
                            }
                        }

                        // Fullscreen - L3 button (left stick press, index 10)
                        if (idx === 10) {
                            safeRequestFullscreen(document.documentElement);
                        }

                        // Reload - R3 button (right stick press, index 11)
                        if (idx === 11) location.reload();

                        if (!fullscreenToggled) {
                            safeRequestFullscreen(document.documentElement);
                            const gamepadAlert = document.getElementById("gamepadAlert");
                            if (gamepadAlert) gamepadAlert.style.display = "none";
                            fullscreenToggled = true;
                        }
                    }
                    prevButtonStates[gp.index][idx] = btn.pressed;
                });
            }
            requestAnimationFrame(pollGamepads);
        }
    </script>
</body>

</html>
